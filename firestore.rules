rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones globales ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner() {
      return request.auth.token.role == 'owner';
    }

    function isAdmin() {
      return request.auth.token.role == 'admin';
    }

    function isClient() {
      return request.auth.token.role == 'client';
    }

    function isDocumentOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- USUARIOS ---
    match /users/{userId} {

      // Crear: cualquier usuario autenticado (sin exigir role)
      allow create: if isSignedIn()
                    && isDocumentOwner(userId);

      // Leer: dueño, admin, owner
      allow read: if isSignedIn()
                   && (isDocumentOwner(userId) || isAdmin() || isOwner());

      // Actualizar:
      // - Clientes NO pueden tocar "role"
      // - Admin y Owner sí pueden
      allow update: if isSignedIn()
                     && (
                          // Dueño actualiza su información normal
                          (isDocumentOwner(userId)
                           && !("role" in request.resource.data))

                          ||

                          // Admin o Owner pueden editar todo
                          isAdmin() || isOwner()
                        );

      // Eliminar: SOLO OWNER
      allow delete: if isSignedIn() && isOwner();
    }


    // --- CUENTAS BANCARIAS ---
    match /accounts/{accountId} {

      // Crear cuenta: SOLO Admin y Owner
      allow create: if isSignedIn()
                    && (isAdmin() || isOwner());

      // Leer: dueño de la cuenta, admin, owner
      allow read: if isSignedIn()
                   && (resource.data.userId == request.auth.uid
                       || isAdmin()
                       || isOwner());

      // Actualizar: admin, owner
      allow update: if isSignedIn()
                     && (isAdmin() || isOwner());

      // Eliminar: SOLO owner
      allow delete: if isSignedIn() && isOwner();
    }


    // --- TRANSACCIONES ---
    match /transactions/{txId} {

      // Crear: SOLO el servidor (via Cloud Function)
      allow create: if false;

      // Leer: dueño, admin, owner
      allow read: if isSignedIn()
                   && (resource.data.userId == request.auth.uid
                       || isAdmin()
                       || isOwner());

      // Update: prohibido
      allow update: if false;

      // Delete: solo owner
      allow delete: if isSignedIn() && isOwner();
    }


    // --- TARJETAS / WALLETS / RETIROS / PAGOS / LO DEMÁS ---
    match /{colName}/{docId} {

      // Crear: Admin + Owner
      allow create: if isSignedIn()
                    && (isAdmin() || isOwner());

      // Leer: cualquier usuario autenticado
      allow read: if isSignedIn();

      // Actualizar:
      // - Clientes no pueden agregar "role"
      // - Admin / Owner pueden todo
      allow update: if isSignedIn()
                     && (
                          isAdmin() || isOwner()
                          || (
                                isClient()
                                && !("role" in request.resource.data)
                             )
                        );

      // Eliminar: solo owner
      allow delete: if isSignedIn() && isOwner();
    }
  }
}

