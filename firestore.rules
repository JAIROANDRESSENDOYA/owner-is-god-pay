rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the requesting user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Defines rules for the 'profiles' collection
    match /profiles/{userId} {
      // READ: A user can get their own document.
      allow get: if isAuthenticated() && isOwner(userId);
      
      // LIST: No user should be able to list all profiles.
      allow list: if false;
      
      // WRITE:
      // - A user can only create or update their own profile.
      allow write: if isAuthenticated() && isOwner(userId);
      
      // Deletion should be handled by a secure backend process.
      allow delete: if false;

      // Users can manage their own subcollections.
      match /{subcollection}/{docId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }

    // Loan applications can be created by any authenticated user.
    // Reading/updating/deleting should be restricted, likely to admins or the user who created it.
    // For now, we allow any authenticated user to create.
    match /loanApplications/{loanId} {
      allow create: if isAuthenticated();
      // Only the user who created the loan or an admin can read/update it.
      // This assumes an 'admin' role is stored somewhere or checked via claims.
      allow read, update: if isAuthenticated() && (resource.data.userId == request.auth.uid);
      allow delete: if false; // Deletions should be handled carefully.
    }
  }
}
